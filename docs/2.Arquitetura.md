# Arquitetura do Sistema

Este documento descreve a arquitetura do sistema de consulta de clima por CEP.

## Visão Geral

O sistema é uma API RESTful desenvolvida em Go que recebe um CEP como entrada, identifica a cidade correspondente e retorna a temperatura atual em três unidades: Celsius, Fahrenheit e Kelvin.

```mermaid
graph LR
    A[Cliente] --> B[API Go - Cloud Run]
    B --> C[ViaCEP API]
    B --> D[WeatherAPI]
    C --> B
    D --> B
    B --> A
```

## Padrões Arquiteturais

### Clean Architecture + Hexagonal Architecture

O projeto segue os princípios de **Clean Architecture** e **Arquitetura Hexagonal**, garantindo:

- **Separação de responsabilidades**: Cada camada tem uma responsabilidade bem definida
- **Independência de frameworks**: O core do negócio não depende de bibliotecas externas
- **Testabilidade**: Uso de interfaces permite fácil criação de mocks
- **Facilidade de manutenção**: Alterações em uma camada não afetam as outras

### Camadas do Sistema

```mermaid
graph TB
    subgraph "Adapters (Infrastructure)"
        A[HTTP Handler]
        B[ViaCEP Client]
        C[WeatherAPI Client]
    end
    
    subgraph "Application (Use Cases)"
        D[GetWeatherByZipcode UseCase]
    end
    
    subgraph "Domain (Core)"
        E[Weather Entity]
        F[Location Entity]
        G[Ports/Interfaces]
    end
    
    A --> D
    D --> B
    D --> C
    D --> E
    D --> F
    B --> G
    C --> G
```

## Estrutura de Camadas

### 1. Domain Layer (Core)

A camada mais interna, contém:

- **Entities**: Estruturas de dados do domínio (`Weather`, `Location`)
- **Ports/Interfaces**: Contratos que as camadas externas devem implementar
  - `LocationRepository`: Interface para busca de localização por CEP
  - `WeatherRepository`: Interface para busca de clima por cidade

### 2. Application Layer (Use Cases)

Contém a lógica de negócio:

- **GetWeatherByZipcodeUseCase**: Orquestra a busca de localização e clima
  1. Valida o CEP
  2. Busca a localização via `LocationRepository`
  3. Busca o clima via `WeatherRepository`
  4. Converte temperaturas para os três formatos
  5. Retorna o resultado

### 3. Infrastructure Layer (Adapters)

Implementações concretas:

- **HTTP Handler**: Recebe requisições HTTP e retorna respostas JSON
- **ViaCEP Client**: Implementação de `LocationRepository` usando a API ViaCEP
- **WeatherAPI Client**: Implementação de `WeatherRepository` usando a API WeatherAPI

## Fluxo de Dados

```mermaid
sequenceDiagram
    participant C as Cliente
    participant H as HTTP Handler
    participant U as UseCase
    participant V as ViaCEP
    participant W as WeatherAPI

    C->>H: GET /weather/{cep}
    H->>U: GetWeather(cep)
    
    alt CEP inválido
        U-->>H: Error (422)
        H-->>C: {"error": "invalid zipcode"}
    end
    
    U->>V: GetLocation(cep)
    
    alt CEP não encontrado
        V-->>U: Not Found
        U-->>H: Error (404)
        H-->>C: {"error": "can not find zipcode"}
    end
    
    V-->>U: Location{city, state}
    U->>W: GetWeather(city)
    W-->>U: Weather{temp_C}
    U->>U: Calculate temp_F, temp_K
    U-->>H: Weather{temp_C, temp_F, temp_K}
    H-->>C: {"temp_C": 28.5, "temp_F": 83.3, "temp_K": 301.5}
```

## Decisões Técnicas

| Aspecto | Decisão | Justificativa |
|---------|---------|---------------|
| Framework HTTP | `net/http` padrão | Simples, sem dependências extras |
| Injeção de Dependência | Manual via construtores | Clareza e simplicidade |
| Configuração | Variáveis de ambiente | Padrão Cloud Native |
| Logs | `slog` (Go 1.21+) | Structured logging nativo |
| Erros | Custom errors com tipos | Melhor tratamento de erros por camada |

## Requisitos Não Funcionais

- **Performance**: Resposta em menos de 2 segundos
- **Disponibilidade**: 99.9% (garantido pelo Cloud Run)
- **Escalabilidade**: Auto-scaling automático via Cloud Run
- **Observabilidade**: Logs estruturados para Cloud Logging
