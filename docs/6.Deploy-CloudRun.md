# Deploy no Google Cloud Run

Este documento descreve o processo de deploy da aplicação no Google Cloud Run.

## Pré-requisitos

### 1. Google Cloud Account

- Conta ativa no Google Cloud Platform
- Projeto criado no GCP
- Billing habilitado (free tier disponível)

### 2. Ferramentas CLI

```bash
# Instalar gcloud CLI
# https://cloud.google.com/sdk/docs/install

# Verificar instalação
gcloud --version

# Autenticar
gcloud auth login

# Configurar projeto
gcloud config set project [PROJECT_ID]
```

### 3. APIs Necessárias

```bash
# Habilitar APIs necessárias
gcloud services enable run.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable containerregistry.googleapis.com
```

---

## Configuração do Projeto

### Variáveis de Ambiente

| Variável | Descrição | Obrigatório |
|----------|-----------|-------------|
| `PORT` | Porta do servidor (Cloud Run define automaticamente) | Não |
| `WEATHER_API_KEY` | Chave da WeatherAPI | Sim |

### Dockerfile Otimizado

```dockerfile
# Build stage
FROM golang:1.25-alpine AS builder

WORKDIR /app

# Copy go.mod first for better cache
COPY go.mod ./
RUN go mod download

# Copy source code
COPY . .

# Build with optimizations
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-w -s" -o /app/server ./cmd/api

# Runtime stage
FROM scratch

# Copy CA certificates for HTTPS
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# Copy binary
COPY --from=builder /app/server /server

# Cloud Run uses PORT env var
EXPOSE 8080

ENTRYPOINT ["/server"]
```

> [!IMPORTANT]
> O Cloud Run requer que a aplicação escute na porta definida pela variável `PORT`.

---

## Métodos de Deploy

### Opção 1: Deploy Direto via Source

O método mais simples, o Cloud Build compila a imagem automaticamente:

```bash
# Deploy direto do código fonte
gcloud run deploy weather-api \
  --source . \
  --region=southamerica-east1 \
  --allow-unauthenticated \
  --set-env-vars="WEATHER_API_KEY=sua-api-key"
```

### Opção 2: Build Local + Deploy

Mais controle sobre o processo de build:

```bash
# 1. Build da imagem
docker build -t gcr.io/[PROJECT_ID]/weather-api:latest .

# 2. Push para Container Registry
docker push gcr.io/[PROJECT_ID]/weather-api:latest

# 3. Deploy no Cloud Run
gcloud run deploy weather-api \
  --image=gcr.io/[PROJECT_ID]/weather-api:latest \
  --region=southamerica-east1 \
  --allow-unauthenticated \
  --set-env-vars="WEATHER_API_KEY=sua-api-key"
```

### Opção 3: Usando Artifact Registry (Recomendado)

```bash
# 1. Criar repositório no Artifact Registry
gcloud artifacts repositories create weather-api \
  --repository-format=docker \
  --location=southamerica-east1

# 2. Configurar Docker para autenticar
gcloud auth configure-docker southamerica-east1-docker.pkg.dev

# 3. Build e tag
docker build -t southamerica-east1-docker.pkg.dev/[PROJECT_ID]/weather-api/weather-api:latest .

# 4. Push
docker push southamerica-east1-docker.pkg.dev/[PROJECT_ID]/weather-api/weather-api:latest

# 5. Deploy
gcloud run deploy weather-api \
  --image=southamerica-east1-docker.pkg.dev/[PROJECT_ID]/weather-api/weather-api:latest \
  --region=southamerica-east1 \
  --allow-unauthenticated \
  --set-env-vars="WEATHER_API_KEY=sua-api-key"
```

---

## Configurações do Cloud Run

### Recursos

| Configuração | Valor Recomendado | Descrição |
|--------------|-------------------|-----------|
| Memory | 128Mi | Suficiente para Go |
| CPU | 1 | 1 vCPU |
| Max instances | 3 | Limita custos no free tier |
| Min instances | 0 | Scale to zero |
| Timeout | 60s | Tempo máximo de resposta |

```bash
gcloud run deploy weather-api \
  --memory=128Mi \
  --cpu=1 \
  --max-instances=3 \
  --min-instances=0 \
  --timeout=60 \
  [... outras flags ...]
```

### Região

Regiões recomendadas para Brasil:

| Região | Localização | Latência Esperada |
|--------|-------------|-------------------|
| `southamerica-east1` | São Paulo | ~5-20ms |
| `us-east1` | Carolina do Sul | ~80-120ms |

---

## CI/CD com GitHub Actions

### Workflow de Deploy Automático

```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: southamerica-east1
  SERVICE: weather-api
  REGION: southamerica-east1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          source: .
          env_vars: |
            WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}
```

### Secrets Necessários

| Secret | Descrição |
|--------|-----------|
| `GCP_PROJECT_ID` | ID do projeto GCP |
| `GCP_CREDENTIALS` | JSON da Service Account |
| `WEATHER_API_KEY` | Chave da WeatherAPI |

---

## Verificação do Deploy

### 1. Verificar Serviço

```bash
# Listar serviços
gcloud run services list

# Obter URL do serviço
gcloud run services describe weather-api --region=southamerica-east1 --format='value(status.url)'
```

### 2. Testar Endpoint

O serviço está ativo no endereço: `https://weather-api-nccto6oxnq-uc.a.run.app`

```bash
# Teste com CEP válido
curl "https://weather-api-nccto6oxnq-uc.a.run.app/weather/01310100"

# Teste com CEP inválido
curl "https://weather-api-nccto6oxnq-uc.a.run.app/weather/123"

# Teste com CEP não encontrado
curl "https://weather-api-nccto6oxnq-uc.a.run.app/weather/99999999"
```

### 3. Verificar Logs

```bash
# Ver logs em tempo real
gcloud run logs read --service=weather-api --region=southamerica-east1 --limit=50
```

---

## Custos

### Free Tier do Cloud Run

| Recurso | Limite Gratuito/Mês |
|---------|---------------------|
| CPU | 180.000 vCPU-segundos |
| Memória | 360.000 GiB-segundos |
| Requisições | 2 milhões |
| Networking | 1 GB de egress |

> [!TIP]
> Para manter no free tier, configure `--max-instances=3` e `--min-instances=0`.

---

## Troubleshooting

### Problemas Comuns

| Problema | Causa | Solução |
|----------|-------|---------|
| Container não inicia | Porta errada | Usar variável `PORT` |
| HTTPS falha | Sem certificados CA | Adicionar no Dockerfile |
| Timeout em APIs | Tempo de resposta alto | Aumentar timeout |
| 502 Bad Gateway | Container crashando | Verificar logs |

```bash
# Debug de container local
docker run -p 8080:8080 -e PORT=8080 -e WEATHER_API_KEY=xxx weather-api
```
